{
    "Comment": "A description of my state machine",
    "StartAt": "GetExecutionId",
    "States": {
        "GetExecutionId": {
            "Type": "Task",
            "Next": "CreateDynamoDB",
            "Parameters": {
                "NumberOfBytes": 4
            },
            "Resource": "arn:aws:states:::aws-sdk:kms:generateRandom",
            "ResultPath": "$.GetExecutionId"
        },
        "CreateDynamoDB": {
            "Type": "Task",
            "Parameters": {
                "BillingMode": "PAY_PER_REQUEST",
                "AttributeDefinitions": [
                    {
                        "AttributeName": "RunId",
                        "AttributeType": "S"
                    }
                ],
                "KeySchema": [
                    {
                        "AttributeName": "RunId",
                        "KeyType": "HASH"
                    }
                ],
                "TableName": "${SpotChaosDynamoTableName}"
            },
            "Resource": "arn:aws:states:::aws-sdk:dynamodb:createTable",
            "Catch": [
                {
                    "ErrorEquals": [
                        "States.ALL"
                    ],
                    "ResultPath": "$.CreateDynamoDB",
                    "Next": "SetExecutionPercentageToZero"
                }
            ],
            "Comment": "If not exists - use catch",
            "Next": "WaitForDDBToBeDiscoverable",
            "ResultPath": "$.CreateDynamoDB"
        },
        "WaitForDDBToBeDiscoverable": {
            "Type": "Wait",
            "Seconds": 5,
            "Next": "SetExecutionPercentageToZero"
        },
        "SetExecutionPercentageToZero": {
            "Type": "Task",
            "Resource": "arn:aws:states:::dynamodb:putItem",
            "Parameters": {
                "TableName": "${SpotChaosDynamoTableName}",
                "Item": {
                    "RunId": {
                        "S.$": "$.GetExecutionId.Plaintext"
                    },
                    "Percentage": {
                        "S": "0"
                    }
                }
            },
            "Comment": "DDB put item",
            "Next": "GetCompletionPercentage",
            "ResultPath": "$.SetExecutionPercentageToZero"
        },
        "GetCompletionPercentage": {
            "Type": "Task",
            "Resource": "arn:aws:states:::dynamodb:getItem",
            "Parameters": {
                "TableName": "${SpotChaosDynamoTableName}",
                "Key": { "RunId": { "S.$": "$.GetExecutionId.Plaintext" } }
            },
            "Comment": "DDB get item",
            "ResultPath": "$.GetCompletionPercentage",
            "Next": "RequestSpot"
        },
        "RequestSpot": {
            "Type": "Task",
            "Parameters": {
                "InstanceCount": 1,
                "LaunchSpecification": {
                    "ImageId": "${SpotChaosInstanceImageId}",
                    "InstanceType": "${SpotChaosInstanceType}",
                    "SubnetId": "${SpotChaosInstanceSubnetId}",
                    "IamInstanceProfile": {
                        "Arn": "${SpotChaosInstanceProfileArn}"
                    },
                    "UserData": "IyEvdXNyL2Jpbi9iYXNoIC14CmNhdCA+L2hvbWUvZWMyLXVzZXIvc2VuZF9tZXRyaWNzLnB5IDw8RU9UCiMhL3Vzci9iaW4vZW52IHB5dGhvbjMKCmltcG9ydCBib3RvMwppbXBvcnQgdGltZQppbXBvcnQgc3lzCmltcG9ydCBzaWduYWwKaW1wb3J0IHVybGxpYi5yZXF1ZXN0CmltcG9ydCBqc29uCgojIEZhaWwgcXVpY2tseQoKdHJ5OgogICAgc3NtX2NsaWVudCA9IGJvdG8zLmNsaWVudCgnc3NtJykKICAgIGRkYl90YWJsZSA9IGJvdG8zLnJlc291cmNlKCdkeW5hbW9kYicpLlRhYmxlKCdEREJUZXN0MScpCiAgICBjd19jbGllbnQgPSBib3RvMy5jbGllbnQoJ2Nsb3Vkd2F0Y2gnKQogICAgZWMyX2NsaWVudCA9IGJvdG8zLmNsaWVudCgnZWMyJykKICAgIHNmbl9jbGllbnQgPSBib3RvMy5jbGllbnQoJ3N0ZXBmdW5jdGlvbnMnKQpleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICBwcmludCgiQ291bGQgbm90IGNvbm5lY3QgdG8gQVdTLCBkaWQgeW91IHNldCBjcmVkZW50aWFscz8iKQogICAgcHJpbnQoZSkKICAgIHN5cy5leGl0KDEpCgojIEdsb2JhbCB2YXJpYWJsZXMgZm9yIHRyYWNraW5nCgpjaGVja3BvaW50X3NhdmVkX3BlcmNlbnRhZ2UgPSAwCnRva2VuPU5vbmUKaW50ZXJydXB0X2xhdGNoPUZhbHNlCgojIEZ1bmN0aW9ucwoKZGVmIHNpZ25hbF9oYW5kbGVyKHNpZyxmcmFtZSk6CiAgICBwcmludChzaWduYWwuU2lnbmFscyhzaWcpKQogICAgcHJpbnQoIkdyYWNlZnVsIGV4aXQgLSByZXBvcnRpbmcgZmluYWwgbWV0cmljcyAtIGNoZWNrcG9pbnRlZCAlZiIgJSBjaGVja3BvaW50X3NhdmVkX3BlcmNlbnRhZ2UpCiAgICAjICMgRG8gbm90IHN1aWNpZGUgaW5zdGFuY2UgLSB3ZSBhc3N1bWUgdGhlIHRlcm1pbmF0aW9uIG5vdGljZSBpcyBndWFyYW50ZWVkCiAgICAjIHRlcm1pbmF0ZV9zZWxmX2luc3RhbmNlcyhlYzJfY2xpZW50KQogICAgc3lzLmV4aXQoMCkKCmRlZiBnZXRfZGRiX2NvbmZpZ3ModGFibGUsaW5zdGFuY2VfaWQpOgogICAgcmVzID0gdGFibGUuZ2V0X2l0ZW0oCiAgICAgICAgS2V5PXsgIlJ1bklkIjogaW5zdGFuY2VfaWQgfSwKICAgICAgICBBdHRyaWJ1dGVzVG9HZXQ9WwogICAgICAgICAgICAiSm9iSWQiLAogICAgICAgICAgICAiSm9iRHVyYXRpb24iLAogICAgICAgICAgICAiQ2hlY2twb2ludER1cmF0aW9uIiwKICAgICAgICAgICAgIkhlYXJ0YmVhdFRva2VuIiwKICAgICAgICAgICAgIlBlcmNlbnRhZ2UiLAogICAgICAgIF0KICAgICkKICAgIHJldHVybiByZXMuZ2V0KCJJdGVtIix7fSkKCmRlZiBnZXRfc3NtX3BhcmFtZXRlcihjbGllbnQsbmFtZSxkZWZhdWx0X3NldHRpbmc9NSk6CiAgICB0cnk6CiAgICAgICAgcmVzcG9uc2UgPSBjbGllbnQuZ2V0X3BhcmFtZXRlcigKICAgICAgICAgICAgTmFtZT1uYW1lLAogICAgICAgICAgICBXaXRoRGVjcnlwdGlvbj1UcnVlCiAgICAgICAgKQogICAgICAgICMgcHJpbnQocmVzcG9uc2UpCiAgICAgICAgdmFsdWUgPSBmbG9hdChyZXNwb25zZS5nZXQoIlBhcmFtZXRlciIse30pLmdldCgiVmFsdWUiLHN0cihkZWZhdWx0X3NldHRpbmcpKSkgCiAgICAgICAgIyBwcmludCgiVmFsdWUgcmV0cmlldmVkOiAlcz0lZiIgJSAobmFtZSx2YWx1ZSkpCiAgICAgICAgcmV0dXJuIHZhbHVlCiAgICBleGNlcHQ6CiAgICAgICAgcHJpbnQoIkNvdWxkbid0IHJlYWQgcGFyYW1ldGVyICVzLCB1c2luZyBkZWZhdWx0IENoZWNrUG9pbnQgZHVyYXRpb24iICUgbmFtZSkKICAgIHJldHVybiBkZWZhdWx0X3NldHRpbmcKCmRlZiBwdXRfY2xvdWR3YXRjaF9wZXJjZW50YWdlcyhjbGllbnQsc2F2ZWRfcGVyY2VudGFnZSx1bnNhdmVkX3BlcmNlbnRhZ2UpOgogICAgY2xpZW50LnB1dF9tZXRyaWNfZGF0YSgKICAgICAgICBNZXRyaWNEYXRhPVsKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgJ01ldHJpY05hbWUnOiAidW5zYXZlZCIsCiAgICAgICAgICAgICAgICAnVW5pdCc6ICdQZXJjZW50JywKICAgICAgICAgICAgICAgICdWYWx1ZSc6IHVuc2F2ZWRfcGVyY2VudGFnZSwKICAgICAgICAgICAgICAgICdTdG9yYWdlUmVzb2x1dGlvbic6IDEKICAgICAgICAgICAgfSwKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgJ01ldHJpY05hbWUnOiAiY2hlY2twb2ludGVkIiwKICAgICAgICAgICAgICAgICdVbml0JzogJ1BlcmNlbnQnLAogICAgICAgICAgICAgICAgJ1ZhbHVlJzogc2F2ZWRfcGVyY2VudGFnZSwKICAgICAgICAgICAgICAgICdTdG9yYWdlUmVzb2x1dGlvbic6IDEKICAgICAgICAgICAgfSwKICAgICAgICBdLAogICAgICAgIE5hbWVzcGFjZT0nZmlzd29ya3Nob3AnCiAgICApCgpkZWYgcHV0X2RkYl9zYXZlZF9wZXJjZW50YWdlKHRhYmxlLGpvYl9pZCxpbnN0YW5jZV9pZCxwZXJjZW50YWdlKToKICAgIHJlcyA9IHRhYmxlLnVwZGF0ZV9pdGVtKAogICAgICAgIEtleT17ICJSdW5JZCI6IGluc3RhbmNlX2lkIH0sCiAgICAgICAgVXBkYXRlRXhwcmVzc2lvbj0ic2V0IFBlcmNlbnRhZ2U9OnAiLAogICAgICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXM9eyAnOnAnOiBzdHIocGVyY2VudGFnZSkgfQogICAgKQogICAgcmVzID0gdGFibGUudXBkYXRlX2l0ZW0oCiAgICAgICAgS2V5PXsgIlJ1bklkIjogam9iX2lkIH0sCiAgICAgICAgVXBkYXRlRXhwcmVzc2lvbj0ic2V0IFBlcmNlbnRhZ2U9OnAiLAogICAgICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXM9eyAnOnAnOiBzdHIocGVyY2VudGFnZSkgfQogICAgKQoKZGVmIGdldF9pbnN0YW5jZV9pZCgpOgogICAgdHJ5OgogICAgICAgIGluc3RhbmNlX2lkID0gdXJsbGliLnJlcXVlc3QudXJsb3BlbignaHR0cDovLzE2OS4yNTQuMTY5LjI1NC9sYXRlc3QvbWV0YS1kYXRhL2luc3RhbmNlLWlkJywgdGltZW91dD0xKS5yZWFkKCkuZGVjb2RlKCkgICAgCiAgICBleGNlcHQ6CiAgICAgICAgIyBObyBpbnN0YW5jZV9pZCAuLi4gYXJlIHdlIHJ1bm5pbmcgaW4gQVdTCiAgICAgICAgaW5zdGFuY2VfaWQgPSAiaS1tYW51YWx0ZXN0IgogICAgcmV0dXJuIGluc3RhbmNlX2lkCgpkZWYgdGVybWluYXRlX3NlbGZfaW5zdGFuY2UoY2xpZW50KToKICAgIGluc3RhbmNlX2lkID0gZ2V0X2luc3RhbmNlX2lkKCkKICAgIGNsaWVudC50ZXJtaW5hdGVfaW5zdGFuY2VzKAogICAgICAgIEluc3RhbmNlSWRzID0gWyBpbnN0YW5jZV9pZCBdCiAgICApCiAgICBwcmludCgiU3VjY2Vzc2Z1bGx5IHNlbnQgaW5zdGFuY2UgdGVybWluYXRpb24gcmVxdWVzdCBmb3IgJXMiICUgaW5zdGFuY2VfaWQpCgpkZWYgY2hlY2tfaW50ZXJydXB0X25vdGljZSgpOgogICAgZ2xvYmFsIHRva2VuCiAgICBnbG9iYWwgaW50ZXJydXB0X2xhdGNoCgogICAgaWYgaW50ZXJydXB0X2xhdGNoOgogICAgICAgIHByaW50KCJBbHJlYWR5IGxhdGNoZWQgaW50ZXJydXB0IikKICAgICAgICByZXR1cm4gVHJ1ZQoKICAgIGlmIG5vdCB0b2tlbjoKICAgICAgICB0cnk6CiAgICAgICAgICAgIHJlcSA9IHVybGxpYi5yZXF1ZXN0LlJlcXVlc3QoCiAgICAgICAgICAgICAgICAnaHR0cDovLzE2OS4yNTQuMTY5LjI1NC9sYXRlc3QvYXBpL3Rva2VuJywKICAgICAgICAgICAgICAgIGhlYWRlcnMgPSB7CiAgICAgICAgICAgICAgICAgICAgIlgtYXdzLWVjMi1tZXRhZGF0YS10b2tlbi10dGwtc2Vjb25kcyI6IDIxNjAwCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgbWV0aG9kPSJQVVQiKQogICAgICAgICAgICB0b2tlbiA9IHVybGxpYi5yZXF1ZXN0LnVybG9wZW4ocmVxLCB0aW1lb3V0PTEpLnJlYWQoKS5kZWNvZGUoKQogICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgcGFzcwoKICAgIHRyeToKICAgICAgICByZXEgPSB1cmxsaWIucmVxdWVzdC5SZXF1ZXN0KAogICAgICAgICAgICAnaHR0cDovLzE2OS4yNTQuMTY5LjI1NC9sYXRlc3QvbWV0YS1kYXRhL3Nwb3QvaW5zdGFuY2UtYWN0aW9uJywKICAgICAgICAgICAgaGVhZGVycyA9IHsKICAgICAgICAgICAgICAgICJYLWF3cy1lYzItbWV0YWRhdGEtdG9rZW4iOiB0b2tlbgogICAgICAgICAgICB9LAogICAgICAgICAgICBtZXRob2Q9IkdFVCIpCiAgICAgICAgcmVzID0gdXJsbGliLnJlcXVlc3QudXJsb3BlbihyZXEsIHRpbmVvdXQ9MSkucmVhZCgpLmRlY29kZSgpCiAgICAgICAgcHJpbnQoIlJlY2VpdmVkIGludGVycnVwdCBub3RpZmljYXRpb246ICVzIiAlIHN0cihyZXMpKQogICAgICAgIHJldHVybiBUcnVlCiAgICBleGNlcHQ6CiAgICAgICAgcGFzcwogICAgcmV0dXJuIEZhbHNlCgpkZWYgc2VuZF90YXNrX2hlYXJiZWF0KGNsaWVudCxoZWFydGJlYXRfdG9rZW4pOgogICAgcmVzcG9uc2UgPSBjbGllbnQuc2VuZF90YXNrX2hlYXJ0YmVhdCgKICAgICAgICB0YXNrVG9rZW49aGVhcnRiZWF0X3Rva2VuCiAgICApCgpkZWYgc2VuZF90YXNrX2ZhaWx1cmUoY2xpZW50LGhlYXJ0YmVhdF90b2tlbixlcnJvcl9jb2RlPTEsZXJyb3JfdGV4dD0iR2VuZXJhbCBFcnJvciIpOgogICAgY2xpZW50LnNlbmRfdGFza19mYWlsdXJlKAogICAgICAgIHRhc2tUb2tlbj1oZWFydGJlYXRfdG9rZW4sCiAgICAgICAgZXJyb3I9ZXJyb3JfY29kZSwKICAgICAgICBjYXVzZT1lcnJvcl90ZXh0CiAgICApCgpkZWYgc2VuZF90YXNrX3N1Y2Nlc3MoY2xpZW50LGhlYXJ0YmVhdF90b2tlbixwZXJjZW50YWdlKToKICAgIGNsaWVudC5zZW5kX3Rhc2tfc3VjY2VzcygKICAgICAgICB0YXNrVG9rZW49aGVhcnRiZWF0X3Rva2VuLAogICAgICAgIG91dHB1dD1qc29uLmR1bXBzKHsKICAgICAgICAgICAgIlBlcmNlbnRhZ2UiOiBzdHIocGVyY2VudGFnZSksCiAgICAgICAgICAgICJKb2JGaW5pc2hlZCI6IChwZXJjZW50YWdlID49IDEwMCkKICAgICAgICAgICAgfSkKICAgICkKCiMgVGhlIGNvZGUKCmNhdGNoYWJsZV9zaWdzID0gc2V0KHNpZ25hbC5TaWduYWxzKSAtIHtzaWduYWwuU0lHS0lMTCwgc2lnbmFsLlNJR1NUT1AsIHNpZ25hbC5TSUdDSExEfQpmb3Igc2lnIGluIGNhdGNoYWJsZV9zaWdzOgogICAgcHJpbnQoImhhbmRsZSAlcyIgJSBzaWcpCiAgICBzaWduYWwuc2lnbmFsKHNpZywgc2lnbmFsX2hhbmRsZXIpCgppbnN0YW5jZV9pZCA9IGdldF9pbnN0YW5jZV9pZCgpCgojIEdldCBjb25maWdzCmZvciBpaSBpbiByYW5nZSgyMCk6CiAgICBjb25maWdzID0gZ2V0X2RkYl9jb25maWdzKGRkYl90YWJsZSxpbnN0YW5jZV9pZCkKICAgIGlmICJIZWFydGJlYXRUb2tlbiIgaW4gY29uZmlnczoKICAgICAgICBicmVhawogICAgcHJpbnQoIk5vIGNvbmZpZ3MgaW4gRHluYW1vREIsIHdhaXRpbmciKQogICAgcHJpbnQoY29uZmlncykKICAgIHRpbWUuc2xlZXAoNSkKaWYgaWkgPj0gMTk6CiAgICBwcmludCgiU29tZXRoaW5nIHdlbnQgd3JvbmcuIFRlcm1pbmF0ZSBydW4iKQogICAgdGVybWluYXRlX3NlbGZfaW5zdGFuY2UoZWMyX2NsaWVudCkKICAgIHN5cy5leGl0KDEpCgojIER1cmF0aW9uIHVudGlsIGpvYiBjb21wbGV0aW9uIGluIG1pbnV0ZXMgKHNob3VsZCBiZSAyIDwgeCA8IDE1KQpqb2JfZHVyYXRpb25fbWludXRlcyA9IGZsb2F0KGNvbmZpZ3NbIkpvYkR1cmF0aW9uIl0pCgojIFRpbWUgYmV0d2VlbiBjaGVja3BvaW50cwpjaGVja3BvaW50X2ludGVydmFsX21pbnV0ZXMgPSBmbG9hdChjb25maWdzWyJDaGVja3BvaW50RHVyYXRpb24iXSkKCmpvYl9pZCA9IGNvbmZpZ3NbIkpvYklkIl0KaGVhcnRiZWF0X3Rva2VuID0gY29uZmlnc1siSGVhcnRiZWF0VG9rZW4iXQpzdGFydF9wZXJjZW50YWdlID0gaW50KGNvbmZpZ3NbIlBlcmNlbnRhZ2UiXSkKCnNsZWVwX2R1cmF0aW9uX3NlY29uZHMgPSA2MC4wICogam9iX2R1cmF0aW9uX21pbnV0ZXMgLyAxMDAuMApjaGVja3BvaW50X2NvdW50ZXJfc2Vjb25kcyA9IDAuMAoKcHJpbnQoIlN0YXJ0aW5nIGpvYiAoZHVyYXRpb24gJWYgbWluIC8gY2hlY2twb2ludCAlZiBtaW4pIiAlICgKICAgIGpvYl9kdXJhdGlvbl9taW51dGVzLAogICAgY2hlY2twb2ludF9pbnRlcnZhbF9taW51dGVzCikpCnB1dF9jbG91ZHdhdGNoX3BlcmNlbnRhZ2VzKGN3X2NsaWVudCwwLDApCnB1dF9kZGJfc2F2ZWRfcGVyY2VudGFnZShkZGJfdGFibGUsam9iX2lkLGluc3RhbmNlX2lkLDApCmZvciBpaSBpbiByYW5nZShzdGFydF9wZXJjZW50YWdlLDEwMCk6CiAgICB0aW1lLnNsZWVwKHNsZWVwX2R1cmF0aW9uX3NlY29uZHMpCgogICAgIyBjaGVja3BvaW50IG9uIHRpbWUgb3IgaW50ZXJydXB0IG5vdGljZQogICAgY2hlY2twb2ludF9jb3VudGVyX3NlY29uZHMgKz0gc2xlZXBfZHVyYXRpb25fc2Vjb25kcwogICAgY2hlY2twb2ludF9mbGFnPSgoY2hlY2twb2ludF9jb3VudGVyX3NlY29uZHMvNjAuMCkgPiBjaGVja3BvaW50X2ludGVydmFsX21pbnV0ZXMpCiAgICBwcmludCgiJWYlJSBjb21wbGV0ZSAtIGNoZWNrcG9pbnQ9JXMiICUgKGlpKzEsY2hlY2twb2ludF9mbGFnKSkKICAgIGlmIGNoZWNrcG9pbnRfZmxhZzoKICAgICAgICBwcmludCgicmVzZXR0aW5nIGZsYWciKQogICAgICAgIGNoZWNrcG9pbnRfY291bnRlcl9zZWNvbmRzID0gMC4wCiAgICAgICAgY2hlY2twb2ludF9zYXZlZF9wZXJjZW50YWdlID0gaWkrMQoKICAgICMgcmVjb3JkIHByb2dyZXNzIGRhdGEgdGhhdCBjYW4gYmUgbG9zdAogICAgcHV0X2Nsb3Vkd2F0Y2hfcGVyY2VudGFnZXMoY3dfY2xpZW50LGNoZWNrcG9pbnRfc2F2ZWRfcGVyY2VudGFnZSxpaSsxKQogICAgcHV0X2RkYl9zYXZlZF9wZXJjZW50YWdlKGRkYl90YWJsZSxqb2JfaWQsaW5zdGFuY2VfaWQsY2hlY2twb2ludF9zYXZlZF9wZXJjZW50YWdlKQogICAgc2VuZF90YXNrX2hlYXJiZWF0KHNmbl9jbGllbnQsaGVhcnRiZWF0X3Rva2VuKQoKICAgICMgRW5kIG9uIGludGVycnVwdAogICAgaWYgY2hlY2tfaW50ZXJydXB0X25vdGljZSgpOgogICAgICAgIGNoZWNrcG9pbnRfc2F2ZWRfcGVyY2VudGFnZSA9IGlpKzEKICAgICAgICBwdXRfY2xvdWR3YXRjaF9wZXJjZW50YWdlcyhjd19jbGllbnQsY2hlY2twb2ludF9zYXZlZF9wZXJjZW50YWdlLGlpKzEpCiAgICAgICAgcHV0X2RkYl9zYXZlZF9wZXJjZW50YWdlKGRkYl90YWJsZSxqb2JfaWQsaW5zdGFuY2VfaWQsY2hlY2twb2ludF9zYXZlZF9wZXJjZW50YWdlKQogICAgICAgIHNlbmRfdGFza19zdWNjZXNzKHNmbl9jbGllbnQsaGVhcnRiZWF0X3Rva2VuLGNoZWNrcG9pbnRfc2F2ZWRfcGVyY2VudGFnZSkKCiMgV3JpdGUgZmluYWwgZGF0YQpwdXRfY2xvdWR3YXRjaF9wZXJjZW50YWdlcyhjd19jbGllbnQsMTAwLDEwMCkKcHV0X2RkYl9zYXZlZF9wZXJjZW50YWdlKGRkYl90YWJsZSxqb2JfaWQsaW5zdGFuY2VfaWQsMTAwKQpzZW5kX3Rhc2tfc3VjY2VzcyhzZm5fY2xpZW50LGhlYXJ0YmVhdF90b2tlbiwxMDApCgojIEF0IGNvbXBsZXRpb24gc3VpY2lkZSBpbnN0YW5jZQp0ZXJtaW5hdGVfc2VsZl9pbnN0YW5jZShlYzJfY2xpZW50KQpFT1QKeXVtIGluc3RhbGwgLXkganEKcGlwMyBpbnN0YWxsIGJvdG8zCmNhdCA+L2hvbWUvZWMyLXVzZXIvc2VuZF9tZXRyaWNzIDw8RU9UCiMhL3Vzci9iaW4vYmFzaAovdXNyL2Jpbi9kYXRlCmV4cG9ydCBBV1NfREVGQVVMVF9SRUdJT049JChjdXJsIC1zIDE2OS4yNTQuMTY5LjI1NC9sYXRlc3QvZHluYW1pYy9pbnN0YW5jZS1pZGVudGl0eS9kb2N1bWVudCB8IGpxIC1yICcucmVnaW9uJykKL3Vzci9iaW4vbm9odXAgL3Vzci9iaW4vcHl0aG9uMyAvaG9tZS9lYzItdXNlci9zZW5kX21ldHJpY3MucHkgMDwmLSAmPj4vdmFyL2xvZy9zZW5kX21ldHJpY3MubG9nICYKL3Vzci9iaW4vZGF0ZQpFT1QKY2htb2QgNzU1IC9ob21lL2VjMi11c2VyL3NlbmRfbWV0cmljcwp0b3VjaCAvdmFyL2xvZy9zZW5kX21ldHJpY3MubG9nCmNobW9kIDY2NiAvdmFyL2xvZy9zZW5kX21ldHJpY3MubG9nCiMvdXNyL2Jpbi9iYXNoIC14IC9ob21lL2VjMi11c2VyL3NlbmRfbWV0cmljcwpjYXQgPi9saWIvc3lzdGVtZC9zeXN0ZW0vc3BvdC5zZXJ2aWNlIDw8RU9UCltVbml0XQpEZXNjcmlwdGlvbj1TdGFydCBmYWtlIHNwb3QgY2FsY3VsYXRpb24KCltTZXJ2aWNlXQpUeXBlPWZvcmtpbmcKRXhlY1N0YXJ0PS91c3IvYmluL2Jhc2ggLXggL2hvbWUvZWMyLXVzZXIvc2VuZF9tZXRyaWNzCkVPVApzeXN0ZW1jdGwgc3RhcnQgc3BvdAo="
                }
            },
            "Resource": "arn:aws:states:::aws-sdk:ec2:requestSpotInstances",
            "Next": "ErrorHandling?",
            "ResultPath": "$.RequestSpot"
        },
        "ErrorHandling?": {
            "Type": "Pass",
            "Next": "GetSpotInfo",
            "Result": {
                "Dummy": "Stuff"
            },
            "ResultPath": "$.SpotRequestErrorHandling"
        },
        "GetSpotInfo": {
            "Type": "Task",
            "Parameters": {
                "SpotInstanceRequestIds.$": "$.RequestSpot.SpotInstanceRequests[*].SpotInstanceRequestId"
            },
            "Resource": "arn:aws:states:::aws-sdk:ec2:describeSpotInstanceRequests",
            "Comment": "See if we have an instance ID yet",
            "Next": "CheckForInstanceId",
            "ResultPath": "$.GetSpotInfo"
        },
        "CheckForInstanceId": {
            "Type": "Choice",
            "Choices": [
                {
                    "Variable": "$.GetSpotInfo.SpotInstanceRequests[0].InstanceId",
                    "IsPresent": true,
                    "Next": "TagSpotInstance"
                }
            ],
            "Default": "WaitForInstanceId"
        },
        "TagSpotInstance": {
            "Type": "Task",
            "Parameters": {
                "ResourceARNList.$": "States.Array(States.Format('${SpotChaosInstanceArnPrefix}{}',$.GetSpotInfo.SpotInstanceRequests[0].InstanceId))",
                "Tags": {
                    "Name": "Fis/Spot"
                }
            },
            "Resource": "arn:aws:states:::aws-sdk:resourcegroupstaggingapi:tagResources",
            "ResultPath": "$.TagSpotInstance",
            "Next": "WaitForJobFinish"
        },
        "WaitForJobFinish": {
            "Type": "Task",
            "Resource": "arn:aws:states:::lambda:invoke.waitForTaskToken",
            "ResultPath": "$.WaitForJobFinish",
            "Parameters": {
              "FunctionName": "${SpotChaosLambdaWaiter}",
              "Payload": {
                "InstanceId.$": "$.GetSpotInfo.SpotInstanceRequests[0].InstanceId",
                "ExecutionId.$": "$.GetExecutionId.Plaintext",
                "HeartbeatToken.$": "$$.Task.Token",
                "JobDuration.$": "$.JobDuration",
                "CheckpointDuration.$": "$.CheckpointDuration",
                "Percentage.$": "$.GetCompletionPercentage.Item.Percentage.S" 
              }
            },
            "TimeoutSeconds": 900,
            "HeartbeatSeconds": 120,
            "Retry": [
              {
                "ErrorEquals": [
                  "Lambda.ServiceException",
                  "Lambda.AWSLambdaException",
                  "Lambda.SdkClientException"
                ],
                "IntervalSeconds": 2,
                "MaxAttempts": 6,
                "BackoffRate": 2
              }
            ],
            "Catch": [
                {
                    "ErrorEquals": [
                        "States.Timeout"
                    ],
                    "ResultPath": "$.WaitForJobFinish",
                    "Next": "GetCompletionPercentage"
                }
            ],
            "Next": "IsFinished?",
            "Comment": "Lambda wait with heartbeat"
        },
        "IsFinished?": {
            "Type": "Choice",
            "Default": "GetCompletionPercentage",
            "Choices": [
                {
                    "Variable": "$.WaitForJobFinish.JobFinished",
                    "BooleanEquals": true,
                    "Next": "CleanDDB?"
                }
            ]
        },
        "CleanDDB?": {
            "Type": "Pass",
            "Next": "WaitMax15min"
        },
        "WaitMax15min": {
            "Type": "Wait",
            "Seconds": 900,
            "Next": "TerminateInstanceIfStillRunning",
            "Comment": "We only allow 15 for spot execution. Wait for 15 min before cleanup"
        },
        "TerminateInstanceIfStillRunning": {
            "Type": "Task",
            "Next": "KillInstances?",
            "Parameters": {
                "InstanceIds.$": "States.Array($.GetSpotInfo.SpotInstanceRequests[0].InstanceId)"
            },
            "Resource": "arn:aws:states:::aws-sdk:ec2:terminateInstances",
            "Catch": [
                {
                    "ErrorEquals": [
                        "States.ALL"
                    ],
                    "ResultPath": "$.TerminateInstanceIfStillRunning",
                    "Next": "KillInstances?"
                }
            ],
            "Comment": "If instance is still running after 15min something went wrong",
            "ResultPath": "$.TerminateInstanceIfStillRunning"
        },
        "KillInstances?": {
            "Type": "Pass",
            "End": true
        },
        "WaitForInstanceId": {
            "Type": "Wait",
            "Seconds": 5,
            "Next": "GetSpotInfo"
        }
    }
}