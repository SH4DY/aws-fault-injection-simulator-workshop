{
    "Comment": "A description of my state machine",
    "StartAt": "GetExecutionId",
    "States": {
        "GetExecutionId": {
            "Type": "Task",
            "Next": "CreateDynamoDB",
            "Parameters": {
                "NumberOfBytes": 4
            },
            "Resource": "arn:aws:states:::aws-sdk:kms:generateRandom",
            "ResultPath": "$.GetExecutionId"
        },
        "CreateDynamoDB": {
            "Type": "Task",
            "Parameters": {
                "BillingMode": "PAY_PER_REQUEST",
                "AttributeDefinitions": [
                    {
                        "AttributeName": "RunId",
                        "AttributeType": "S"
                    }
                ],
                "KeySchema": [
                    {
                        "AttributeName": "RunId",
                        "KeyType": "HASH"
                    }
                ],
                "TableName": "DDBTest1"
            },
            "Resource": "arn:aws:states:::aws-sdk:dynamodb:createTable",
            "Catch": [
                {
                    "ErrorEquals": [
                        "States.ALL"
                    ],
                    "ResultPath": "$.CreateDynamoDB",
                    "Next": "SetExecutionPercentageToZero"
                }
            ],
            "Comment": "If not exists - use catch",
            "Next": "WaitForDDBToBeDiscoverable",
            "ResultPath": "$.CreateDynamoDB"
        },
        "WaitForDDBToBeDiscoverable": {
            "Type": "Wait",
            "Seconds": 5,
            "Next": "SetExecutionPercentageToZero"
        },
        "SetExecutionPercentageToZero": {
            "Type": "Task",
            "Resource": "arn:aws:states:::dynamodb:putItem",
            "Parameters": {
                "TableName": "DDBTest1",
                "Item": {
                    "RunId": {
                        "S.$": "$.GetExecutionId.Plaintext"
                    },
                    "PercentComplete": {
                        "S": "0"
                    }
                }
            },
            "Comment": "DDB put item",
            "Next": "WriteSSMParameter",
            "ResultPath": "$.SetExecutionPercentageToZero"
        },
        "WriteSSMParameter": {
            "Type": "Pass",
            "Next": "RequestSpot",
            "Comment": "Save startpercentage! duration? Save DDB table name?",
            "Result": {
                "Dummy": "Stuff"
            },
            "ResultPath": "$.WriteSSMParameter"
        },
        "RequestSpot": {
            "Type": "Task",
            "Parameters": {
                "InstanceCount": 1,
                "LaunchSpecification": {
                    "ImageId": "${SpotChaosInstanceImageId}",
                    "InstanceType": "${SpotChaosInstanceType}",
                    "SubnetId": "${SpotChaosInstanceSubnetId}",
                    "IamInstanceProfile": {
                        "Arn": "${SpotChaosInstanceProfileArn}"
                    },
                    "UserData": "IyEvdXNyL2Jpbi9iYXNoIC14CmNhdCA+L2hvbWUvZWMyLXVzZXIvc2VuZF9tZXRyaWNzLnB5IDw8RU9UCiMhL3Vzci9iaW4vZW52IHB5dGhvbjMKCmltcG9ydCBib3RvMwppbXBvcnQgdGltZQppbXBvcnQgc3lzCmltcG9ydCBzaWduYWwKaW1wb3J0IHVybGxpYi5yZXF1ZXN0CmltcG9ydCBqc29uCgojIEZhaWwgcXVpY2tseQoKdHJ5OgogICAgc3NtX2NsaWVudCA9IGJvdG8zLmNsaWVudCgnc3NtJykKICAgIGRkYl90YWJsZSA9IGJvdG8zLnJlc291cmNlKCdkeW5hbW9kYicpLlRhYmxlKCdEREJUZXN0MScpCiAgICBjd19jbGllbnQgPSBib3RvMy5jbGllbnQoJ2Nsb3Vkd2F0Y2gnKQogICAgZWMyX2NsaWVudCA9IGJvdG8zLmNsaWVudCgnZWMyJykKICAgIHNmbl9jbGllbnQgPSBib3RvMy5jbGllbnQoJ3N0ZXBmdW5jdGlvbnMnKQpleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICBwcmludCgiQ291bGQgbm90IGNvbm5lY3QgdG8gQVdTLCBkaWQgeW91IHNldCBjcmVkZW50aWFscz8iKQogICAgcHJpbnQoZSkKICAgIHN5cy5leGl0KDEpCgojIEdsb2JhbCB2YXJpYWJsZXMgZm9yIHRyYWNraW5nCgpjaGVja3BvaW50X3NhdmVkX3BlcmNlbnRhZ2UgPSAwCnRva2VuPU5vbmUKaW50ZXJydXB0X2xhdGNoPUZhbHNlCgojIEZ1bmN0aW9ucwoKZGVmIHNpZ25hbF9oYW5kbGVyKHNpZyxmcmFtZSk6CiAgICBwcmludChzaWduYWwuU2lnbmFscyhzaWcpKQogICAgcHJpbnQoIkdyYWNlZnVsIGV4aXQgLSByZXBvcnRpbmcgZmluYWwgbWV0cmljcyAtIGNoZWNrcG9pbnRlZCAlZiIgJSBjaGVja3BvaW50X3NhdmVkX3BlcmNlbnRhZ2UpCiAgICAjICMgRG8gbm90IHN1aWNpZGUgaW5zdGFuY2UgLSB3ZSBhc3N1bWUgdGhlIHRlcm1pbmF0aW9uIG5vdGljZSBpcyBndWFyYW50ZWVkCiAgICAjIHRlcm1pbmF0ZV9zZWxmX2luc3RhbmNlcyhlYzJfY2xpZW50KQogICAgc3lzLmV4aXQoMCkKCmRlZiBnZXRfZGRiX2NvbmZpZ3ModGFibGUsaW5zdGFuY2VfaWQpOgogICAgcmVzID0gdGFibGUuZ2V0X2l0ZW0oCiAgICAgICAgS2V5PXsgIlJ1bklkIjogaW5zdGFuY2VfaWQgfSwKICAgICAgICBBdHRyaWJ1dGVzVG9HZXQ9WwogICAgICAgICAgICAiSm9iSWQiLAogICAgICAgICAgICAiSm9iRHVyYXRpb24iLAogICAgICAgICAgICAiQ2hlY2twb2ludER1cmF0aW9uIiwKICAgICAgICAgICAgIkhlYXJ0YmVhdFRva2VuIiwKICAgICAgICAgICAgIlN0YXJ0UGVyY2VudGFnZSIsCiAgICAgICAgXQogICAgKQogICAgcmV0dXJuIHJlcy5nZXQoIkl0ZW0iLHt9KQoKZGVmIGdldF9zc21fcGFyYW1ldGVyKGNsaWVudCxuYW1lLGRlZmF1bHRfc2V0dGluZz01KToKICAgIHRyeToKICAgICAgICByZXNwb25zZSA9IGNsaWVudC5nZXRfcGFyYW1ldGVyKAogICAgICAgICAgICBOYW1lPW5hbWUsCiAgICAgICAgICAgIFdpdGhEZWNyeXB0aW9uPVRydWUKICAgICAgICApCiAgICAgICAgIyBwcmludChyZXNwb25zZSkKICAgICAgICB2YWx1ZSA9IGZsb2F0KHJlc3BvbnNlLmdldCgiUGFyYW1ldGVyIix7fSkuZ2V0KCJWYWx1ZSIsc3RyKGRlZmF1bHRfc2V0dGluZykpKSAKICAgICAgICAjIHByaW50KCJWYWx1ZSByZXRyaWV2ZWQ6ICVzPSVmIiAlIChuYW1lLHZhbHVlKSkKICAgICAgICByZXR1cm4gdmFsdWUKICAgIGV4Y2VwdDoKICAgICAgICBwcmludCgiQ291bGRuJ3QgcmVhZCBwYXJhbWV0ZXIgJXMsIHVzaW5nIGRlZmF1bHQgQ2hlY2tQb2ludCBkdXJhdGlvbiIgJSBuYW1lKQogICAgcmV0dXJuIGRlZmF1bHRfc2V0dGluZwoKZGVmIHB1dF9jbG91ZHdhdGNoX3BlcmNlbnRhZ2VzKGNsaWVudCxzYXZlZF9wZXJjZW50YWdlLHVuc2F2ZWRfcGVyY2VudGFnZSk6CiAgICBjbGllbnQucHV0X21ldHJpY19kYXRhKAogICAgICAgIE1ldHJpY0RhdGE9WwogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAnTWV0cmljTmFtZSc6ICJ1bnNhdmVkIiwKICAgICAgICAgICAgICAgICdVbml0JzogJ1BlcmNlbnQnLAogICAgICAgICAgICAgICAgJ1ZhbHVlJzogdW5zYXZlZF9wZXJjZW50YWdlLAogICAgICAgICAgICAgICAgJ1N0b3JhZ2VSZXNvbHV0aW9uJzogMQogICAgICAgICAgICB9LAogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAnTWV0cmljTmFtZSc6ICJjaGVja3BvaW50ZWQiLAogICAgICAgICAgICAgICAgJ1VuaXQnOiAnUGVyY2VudCcsCiAgICAgICAgICAgICAgICAnVmFsdWUnOiBzYXZlZF9wZXJjZW50YWdlLAogICAgICAgICAgICAgICAgJ1N0b3JhZ2VSZXNvbHV0aW9uJzogMQogICAgICAgICAgICB9LAogICAgICAgIF0sCiAgICAgICAgTmFtZXNwYWNlPSdmaXN3b3Jrc2hvcCcKICAgICkKCmRlZiBnZXRfaW5zdGFuY2VfaWQoKToKICAgIHRyeToKICAgICAgICBpbnN0YW5jZV9pZCA9IHVybGxpYi5yZXF1ZXN0LnVybG9wZW4oJ2h0dHA6Ly8xNjkuMjU0LjE2OS4yNTQvbGF0ZXN0L21ldGEtZGF0YS9pbnN0YW5jZS1pZCcsIHRpbWVvdXQ9MSkucmVhZCgpLmRlY29kZSgpICAgIAogICAgZXhjZXB0OgogICAgICAgICMgTm8gaW5zdGFuY2VfaWQgLi4uIGFyZSB3ZSBydW5uaW5nIGluIEFXUwogICAgICAgIGluc3RhbmNlX2lkID0gImktbWFudWFsdGVzdCIKICAgIHJldHVybiBpbnN0YW5jZV9pZAoKZGVmIHRlcm1pbmF0ZV9zZWxmX2luc3RhbmNlKGNsaWVudCk6CiAgICBpbnN0YW5jZV9pZCA9IGdldF9pbnN0YW5jZV9pZCgpCiAgICBjbGllbnQudGVybWluYXRlX2luc3RhbmNlcygKICAgICAgICBJbnN0YW5jZUlkcyA9IFsgaW5zdGFuY2VfaWQgXQogICAgKQogICAgcHJpbnQoIlN1Y2Nlc3NmdWxseSBzZW50IGluc3RhbmNlIHRlcm1pbmF0aW9uIHJlcXVlc3QgZm9yICVzIiAlIGluc3RhbmNlX2lkKQoKZGVmIGNoZWNrX2ludGVycnVwdF9ub3RpY2UoKToKICAgIGdsb2JhbCB0b2tlbgogICAgZ2xvYmFsIGludGVycnVwdF9sYXRjaAoKICAgIGlmIGludGVycnVwdF9sYXRjaDoKICAgICAgICBwcmludCgiQWxyZWFkeSBsYXRjaGVkIGludGVycnVwdCIpCiAgICAgICAgcmV0dXJuIFRydWUKCiAgICBpZiBub3QgdG9rZW46CiAgICAgICAgdHJ5OgogICAgICAgICAgICByZXEgPSB1cmxsaWIucmVxdWVzdC5SZXF1ZXN0KAogICAgICAgICAgICAgICAgJ2h0dHA6Ly8xNjkuMjU0LjE2OS4yNTQvbGF0ZXN0L2FwaS90b2tlbicsCiAgICAgICAgICAgICAgICBoZWFkZXJzID0gewogICAgICAgICAgICAgICAgICAgICJYLWF3cy1lYzItbWV0YWRhdGEtdG9rZW4tdHRsLXNlY29uZHMiOiAyMTYwMAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIG1ldGhvZD0iUFVUIikKICAgICAgICAgICAgdG9rZW4gPSB1cmxsaWIucmVxdWVzdC51cmxvcGVuKHJlcSwgdGltZW91dD0xKS5yZWFkKCkuZGVjb2RlKCkKICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgIHBhc3MKCiAgICB0cnk6CiAgICAgICAgcmVxID0gdXJsbGliLnJlcXVlc3QuUmVxdWVzdCgKICAgICAgICAgICAgJ2h0dHA6Ly8xNjkuMjU0LjE2OS4yNTQvbGF0ZXN0L21ldGEtZGF0YS9zcG90L2luc3RhbmNlLWFjdGlvbicsCiAgICAgICAgICAgIGhlYWRlcnMgPSB7CiAgICAgICAgICAgICAgICAiWC1hd3MtZWMyLW1ldGFkYXRhLXRva2VuIjogdG9rZW4KICAgICAgICAgICAgfSwKICAgICAgICAgICAgbWV0aG9kPSJHRVQiKQogICAgICAgIHJlcyA9IHVybGxpYi5yZXF1ZXN0LnVybG9wZW4ocmVxLCB0aW5lb3V0PTEpLnJlYWQoKS5kZWNvZGUoKQogICAgICAgIHByaW50KCJSZWNlaXZlZCBpbnRlcnJ1cHQgbm90aWZpY2F0aW9uOiAlcyIgJSBzdHIocmVzKSkKICAgICAgICByZXR1cm4gVHJ1ZQogICAgZXhjZXB0OgogICAgICAgIHBhc3MKICAgIHJldHVybiBGYWxzZQoKZGVmIHNlbmRfdGFza19oZWFyYmVhdChjbGllbnQsaGVhcnRiZWF0X3Rva2VuKToKICAgIHJlc3BvbnNlID0gY2xpZW50LnNlbmRfdGFza19oZWFydGJlYXQoCiAgICAgICAgdGFza1Rva2VuPWhlYXJ0YmVhdF90b2tlbgogICAgKQoKZGVmIHNlbmRfdGFza19mYWlsdXJlKGNsaWVudCxoZWFydGJlYXRfdG9rZW4sZXJyb3JfY29kZT0xLGVycm9yX3RleHQ9IkdlbmVyYWwgRXJyb3IiKToKICAgIGNsaWVudC5zZW5kX3Rhc2tfZmFpbHVyZSgKICAgICAgICB0YXNrVG9rZW49aGVhcnRiZWF0X3Rva2VuLAogICAgICAgIGVycm9yPWVycm9yX2NvZGUsCiAgICAgICAgY2F1c2U9ZXJyb3JfdGV4dAogICAgKQoKZGVmIHNlbmRfdGFza19zdWNjZXNzKGNsaWVudCxoZWFydGJlYXRfdG9rZW4scGVyY2VudGFnZSk6CiAgICBjbGllbnQuc2VuZF90YXNrX3N1Y2Nlc3MoCiAgICAgICAgdGFza1Rva2VuPWhlYXJ0YmVhdF90b2tlbiwKICAgICAgICBvdXRwdXQ9anNvbi5kdW1wcyh7CiAgICAgICAgICAgICJQZXJjZW50YWdlIjogcGVyY2VudGFnZSwKICAgICAgICAgICAgIkpvYkZpbmlzaGVkIjogKHBlcmNlbnRhZ2UgPj0gMTAwKQogICAgICAgICAgICB9KQogICAgKQoKIyBUaGUgY29kZQoKY2F0Y2hhYmxlX3NpZ3MgPSBzZXQoc2lnbmFsLlNpZ25hbHMpIC0ge3NpZ25hbC5TSUdLSUxMLCBzaWduYWwuU0lHU1RPUCwgc2lnbmFsLlNJR0NITER9CmZvciBzaWcgaW4gY2F0Y2hhYmxlX3NpZ3M6CiAgICBwcmludCgiaGFuZGxlICVzIiAlIHNpZykKICAgIHNpZ25hbC5zaWduYWwoc2lnLCBzaWduYWxfaGFuZGxlcikKCiMgR2V0IGNvbmZpZ3MKZm9yIGlpIGluIHJhbmdlKDIwKToKICAgIGNvbmZpZ3MgPSBnZXRfZGRiX2NvbmZpZ3MoZGRiX3RhYmxlLGdldF9pbnN0YW5jZV9pZCgpKQogICAgaWYgIkhlYXJ0YmVhdFRva2VuIiBpbiBjb25maWdzOgogICAgICAgIGJyZWFrCiAgICBwcmludCgiTm8gY29uZmlncyBpbiBEeW5hbW9EQiwgd2FpdGluZyIpCiAgICBwcmludChjb25maWdzKQogICAgdGltZS5zbGVlcCg1KQppZiBpaSA+PSAxOToKICAgIHByaW50KCJTb21ldGhpbmcgd2VudCB3cm9uZy4gVGVybWluYXRlIHJ1biIpCiAgICB0ZXJtaW5hdGVfc2VsZl9pbnN0YW5jZShlYzJfY2xpZW50KQogICAgc3lzLmV4aXQoMSkKCiMgRHVyYXRpb24gdW50aWwgam9iIGNvbXBsZXRpb24gaW4gbWludXRlcyAoc2hvdWxkIGJlIDIgPCB4IDwgMTUpCmpvYl9kdXJhdGlvbl9taW51dGVzID0gZmxvYXQoY29uZmlnc1siSm9iRHVyYXRpb24iXSkKCiMgVGltZSBiZXR3ZWVuIGNoZWNrcG9pbnRzCmNoZWNrcG9pbnRfaW50ZXJ2YWxfbWludXRlcyA9IGZsb2F0KGNvbmZpZ3NbIkNoZWNrcG9pbnREdXJhdGlvbiJdKQoKIyBKb2IgSUQKam9iX2lkID0gY29uZmlnc1siSm9iSWQiXQoKIyBIZWFydGJlYXQgdG9rZW4KaGVhcnRiZWF0X3Rva2VuID0gY29uZmlnc1siSGVhcnRiZWF0VG9rZW4iXQoKc2xlZXBfZHVyYXRpb25fc2Vjb25kcyA9IDYwLjAgKiBqb2JfZHVyYXRpb25fbWludXRlcyAvIDEwMC4wCmNoZWNrcG9pbnRfY291bnRlcl9zZWNvbmRzID0gMC4wCgpwcmludCgiU3RhcnRpbmcgam9iIChkdXJhdGlvbiAlZiBtaW4gLyBjaGVja3BvaW50ICVmIG1pbikiICUgKAogICAgam9iX2R1cmF0aW9uX21pbnV0ZXMsCiAgICBjaGVja3BvaW50X2ludGVydmFsX21pbnV0ZXMKKSkKcHV0X2Nsb3Vkd2F0Y2hfcGVyY2VudGFnZXMoY3dfY2xpZW50LDAsMCkKZm9yIGlpIGluIHJhbmdlKDEwMCk6CiAgICB0aW1lLnNsZWVwKHNsZWVwX2R1cmF0aW9uX3NlY29uZHMpCgogICAgIyBjaGVja3BvaW50IG9uIHRpbWUgb3IgaW50ZXJydXB0IG5vdGljZQogICAgY2hlY2twb2ludF9jb3VudGVyX3NlY29uZHMgKz0gc2xlZXBfZHVyYXRpb25fc2Vjb25kcwogICAgY2hlY2twb2ludF9mbGFnPSgoY2hlY2twb2ludF9jb3VudGVyX3NlY29uZHMvNjAuMCkgPiBjaGVja3BvaW50X2ludGVydmFsX21pbnV0ZXMpCiAgICBwcmludCgiJWYlJSBjb21wbGV0ZSAtIGNoZWNrcG9pbnQ9JXMiICUgKGlpKzEsY2hlY2twb2ludF9mbGFnKSkKICAgIGlmIGNoZWNrcG9pbnRfZmxhZzoKICAgICAgICBwcmludCgicmVzZXR0aW5nIGZsYWciKQogICAgICAgIGNoZWNrcG9pbnRfY291bnRlcl9zZWNvbmRzID0gMC4wCiAgICAgICAgY2hlY2twb2ludF9zYXZlZF9wZXJjZW50YWdlID0gaWkrMQoKICAgICMgcmVjb3JkIHByb2dyZXNzIGRhdGEgdGhhdCBjYW4gYmUgbG9zdAogICAgcHV0X2Nsb3Vkd2F0Y2hfcGVyY2VudGFnZXMoY3dfY2xpZW50LGNoZWNrcG9pbnRfc2F2ZWRfcGVyY2VudGFnZSxpaSsxKQogICAgc2VuZF90YXNrX2hlYXJiZWF0KHNmbl9jbGllbnQsaGVhcnRiZWF0X3Rva2VuKQoKICAgICMgRW5kIG9uIGludGVycnVwdAogICAgaWYgY2hlY2tfaW50ZXJydXB0X25vdGljZSgpOgogICAgICAgIGNoZWNrcG9pbnRfc2F2ZWRfcGVyY2VudGFnZSA9IGlpKzEKICAgICAgICBwdXRfY2xvdWR3YXRjaF9wZXJjZW50YWdlcyhjd19jbGllbnQsY2hlY2twb2ludF9zYXZlZF9wZXJjZW50YWdlLGlpKzEpCiAgICAgICAgc2VuZF90YXNrX3N1Y2Nlc3Moc2ZuX2NsaWVudCxoZWFydGJlYXRfdG9rZW4sY2hlY2twb2ludF9zYXZlZF9wZXJjZW50YWdlKQoKIyBXcml0ZSBmaW5hbCBkYXRhCnB1dF9jbG91ZHdhdGNoX3BlcmNlbnRhZ2VzKGN3X2NsaWVudCwxMDAsMTAwKQpzZW5kX3Rhc2tfc3VjY2VzcyhzZm5fY2xpZW50LGhlYXJ0YmVhdF90b2tlbiwxMDApCgojIEF0IGNvbXBsZXRpb24gc3VpY2lkZSBpbnN0YW5jZQp0ZXJtaW5hdGVfc2VsZl9pbnN0YW5jZShlYzJfY2xpZW50KQpFT1QKeXVtIGluc3RhbGwgLXkganEKcGlwMyBpbnN0YWxsIGJvdG8zCmNhdCA+L2hvbWUvZWMyLXVzZXIvc2VuZF9tZXRyaWNzIDw8RU9UCiMhL3Vzci9iaW4vYmFzaAovdXNyL2Jpbi9kYXRlCmV4cG9ydCBBV1NfREVGQVVMVF9SRUdJT049JChjdXJsIC1zIDE2OS4yNTQuMTY5LjI1NC9sYXRlc3QvZHluYW1pYy9pbnN0YW5jZS1pZGVudGl0eS9kb2N1bWVudCB8IGpxIC1yICcucmVnaW9uJykKL3Vzci9iaW4vbm9odXAgL3Vzci9iaW4vcHl0aG9uMyAvaG9tZS9lYzItdXNlci9zZW5kX21ldHJpY3MucHkgMDwmLSAmPj4vdmFyL2xvZy9zZW5kX21ldHJpY3MubG9nICYKL3Vzci9iaW4vZGF0ZQpFT1QKY2htb2QgNzU1IC9ob21lL2VjMi11c2VyL3NlbmRfbWV0cmljcwp0b3VjaCAvdmFyL2xvZy9zZW5kX21ldHJpY3MubG9nCmNobW9kIDY2NiAvdmFyL2xvZy9zZW5kX21ldHJpY3MubG9nCiMvdXNyL2Jpbi9iYXNoIC14IC9ob21lL2VjMi11c2VyL3NlbmRfbWV0cmljcwpjYXQgPi9saWIvc3lzdGVtZC9zeXN0ZW0vc3BvdC5zZXJ2aWNlIDw8RU9UCltVbml0XQpEZXNjcmlwdGlvbj1TdGFydCBmYWtlIHNwb3QgY2FsY3VsYXRpb24KCltTZXJ2aWNlXQpUeXBlPWZvcmtpbmcKRXhlY1N0YXJ0PS91c3IvYmluL2Jhc2ggLXggL2hvbWUvZWMyLXVzZXIvc2VuZF9tZXRyaWNzCkVPVApzeXN0ZW1jdGwgc3RhcnQgc3BvdAo="
                }
            },
            "Resource": "arn:aws:states:::aws-sdk:ec2:requestSpotInstances",
            "Next": "ErrorHandling?",
            "ResultPath": "$.RequestSpot"
        },
        "ErrorHandling?": {
            "Type": "Pass",
            "Next": "GetSpotInfo",
            "Result": {
                "Dummy": "Stuff"
            },
            "ResultPath": "$.SpotRequestErrorHandling"
        },
        "GetSpotInfo": {
            "Type": "Task",
            "Parameters": {
                "SpotInstanceRequestIds.$": "$.RequestSpot.SpotInstanceRequests[*].SpotInstanceRequestId"
            },
            "Resource": "arn:aws:states:::aws-sdk:ec2:describeSpotInstanceRequests",
            "Comment": "See if we have an instance ID yet",
            "Next": "CheckForInstanceId",
            "ResultPath": "$.GetSpotInfo"
        },
        "CheckForInstanceId": {
            "Type": "Choice",
            "Choices": [
                {
                    "Variable": "$.GetSpotInfo.SpotInstanceRequests[0].InstanceId",
                    "IsPresent": true,
                    "Next": "TagSpotInstance"
                }
            ],
            "Default": "WaitForInstanceId"
        },
        "TagSpotInstance": {
            "Type": "Task",
            "Parameters": {
                "ResourceARNList.$": "States.Array(States.Format('${SpotChaosInstanceArnPrefix}{}',$.GetSpotInfo.SpotInstanceRequests[0].InstanceId))",
                "Tags": {
                    "Name": "Fis/Spot"
                }
            },
            "Resource": "arn:aws:states:::aws-sdk:resourcegroupstaggingapi:tagResources",
            "ResultPath": "$.TagSpotInstance",
            "Next": "WaitForJobFinish"
        },
        "WaitForJobFinish": {
            "Type": "Task",
            "Resource": "arn:aws:states:::lambda:invoke.waitForTaskToken",
            "ResultPath": "$.WaitForJobFinish",
            "Parameters": {
              "FunctionName": "${SpotChaosLambdaWaiter}",
              "Payload": {
                "InstanceId.$": "$.GetSpotInfo.SpotInstanceRequests[0].InstanceId",
                "ExecutionId.$": "$.GetExecutionId.Plaintext",
                "HeartbeatToken.$": "$$.Task.Token",
                "JobDuration.$": "$.JobDuration",
                "CheckpointDuration.$": "$.CheckpointDuration",
                "StartPercentage.$": "$.WaitForJobFinish.Percentage" 
              }
            },
            "TimeoutSeconds": 900,
            "HeartbeatSeconds": 120,
            "Retry": [
              {
                "ErrorEquals": [
                  "Lambda.ServiceException",
                  "Lambda.AWSLambdaException",
                  "Lambda.SdkClientException"
                ],
                "IntervalSeconds": 2,
                "MaxAttempts": 6,
                "BackoffRate": 2
              }
            ],
            "Next": "IsFinished?",
            "Comment": "Lambda wait with heartbeat"
        },
        "IsFinished?": {
            "Type": "Choice",
            "Default": "WriteSSMParameter",
            "Choices": [
                {
                    "Variable": "$.WaitForJobFinish.JobFinished",
                    "BooleanEquals": true,
                    "Next": "CleanDDB?"
                }
            ]
        },
        "CleanDDB?": {
            "Type": "Pass",
            "Next": "WaitMax15min"
        },
        "WaitMax15min": {
            "Type": "Wait",
            "Seconds": 900,
            "Next": "TerminateInstanceIfStillRunning",
            "Comment": "We only allow 15 for spot execution. Wait for 15 min before cleanup"
        },
        "TerminateInstanceIfStillRunning": {
            "Type": "Task",
            "Next": "KillInstances?",
            "Parameters": {
                "InstanceIds.$": "States.Array($.GetSpotInfo.SpotInstanceRequests[0].InstanceId)"
            },
            "Resource": "arn:aws:states:::aws-sdk:ec2:terminateInstances",
            "Catch": [
                {
                    "ErrorEquals": [
                        "States.ALL"
                    ],
                    "ResultPath": "$.TerminateInstanceIfStillRunning",
                    "Next": "KillInstances?"
                }
            ],
            "Comment": "If instance is still running after 15min something went wrong",
            "ResultPath": "$.TerminateInstanceIfStillRunning"
        },
        "KillInstances?": {
            "Type": "Pass",
            "End": true
        },
        "WaitForInstanceId": {
            "Type": "Wait",
            "Seconds": 5,
            "Next": "GetSpotInfo"
        }
    }
}