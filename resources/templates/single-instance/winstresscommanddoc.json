{
    "schemaVersion": "2.2",
    "description": "Stress Windows CPU.",
    "parameters": {
      "workingDirectory": {
        "type": "String",
        "default": "",
        "description": "(Optional) The path to the working directory on your instance.",
        "maxChars": 4096
      },
      "duration": {
        "type": "String",
        "default": "120",
        "description": "Duration of test in seconds.",
        "allowedPattern": "([1-9][0-9]{0,4})|(1[0-6][0-9]{4})|(17[0-1][0-9]{3})|(172[0-7][0-9]{2})|(172800)"
      },
      "executionTimeout": {
        "type": "String",
        "default": "3600",
        "description": "(Optional) The time in seconds for a command to be completed before it is considered to have failed. Default is 3600 (1 hour). Maximum is 172800 (48 hours).",
        "allowedPattern": "([1-9][0-9]{0,4})|(1[0-6][0-9]{4})|(17[0-1][0-9]{3})|(172[0-7][0-9]{2})|(172800)"
      }
    },
    "mainSteps": [
      {
        "action": "aws:runPowerShellScript",
        "name": "invokeCpuStress",
        "precondition": {
          "StringEquals": [
            "platformType",
            "Windows"
          ]
        },
        "inputs": {
          "runCommand": [
            "try {",
            "    $NumThreads = Get-WmiObject win32_processor | Select-Object -ExpandProperty NumberOfLogicalProcessors",
            "    $StartDate = Get-Date -ErrorAction Stop",
            "    Write-Output \"============= CPU Stress Test Started: $StartDate =============\"",
            "    foreach ($loopnumber in 1..$NumThreads){",
            "        Start-Job -ScriptBlock{",
            "        $result = 1",
            "            foreach ($number in 1..2147483647){",
            "                $result = $result * $number",
            "            }",
            "        } -Name SSMCpuJob$loopnumber -ErrorAction Stop",
            "    }",
            "    Start-Sleep -s {{duration}}",
            "    Stop-Job -Name SSMCpuJob* -ErrorAction Stop",
            "    $EndDate = Get-Date -ErrorAction Stop",
            "    Write-Output \"============= CPU Stress Test Complete: $EndDate =============\"",
            "    Get-Job -ErrorAction Stop | Remove-Job -ErrorAction Stop",
            "} catch {",
            "    Write-Host \"Failed to Run CPU Stress Test\"",
            "    Get-Job -ErrorAction Stop | Remove-Job -ErrorAction Stop",
            "    Exit 1",
            "}"
          ]
        }
      }
    ]
}
            